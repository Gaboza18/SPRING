<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mappings.order-mapping">

	<!-- 주문 seq 생성:oseq 있으면 +1, 없으면  1부터 시작 -->
	<select id="selectMaxOseq" resultType="int">
		SELECT NVL2(MAX(oseq), MAX(oseq)+1,1) FROM orders
	</select>
	
	<!-- 새로운 주문 생성 -->
	<insert id="insertOrder">
		INSERT INTO orders(oseq, id) VALUES(#{oseq}, #{id}) 
	</insert>
	
	<!-- 주문 상세 테이블에 상품 상세정보 생성 -->
	<insert id="insertOrderDetail">
		INSERT INTO order_detail(odseq, oseq, pseq, quantity) 
			VALUES(order_detail_seq.NEXTVAL, #{oseq}, #{oseq}, #{quantity})
	</insert>
	
	<!-- 주문내역 조회 -->
	<select id="listOrderById" resultType="order">
		SELECT * FROM order_view
			WHERE id=#{id} 
				AND result LIKE '%'||#{result}||'%' 
				AND oseq=#{oseq}
	</select>
	
	<!-- 사용자별 주문번호 목록 조회 -->
	<!-- '주문번호'를 '사용자 id'를 조건, 주문결과가 포함시켜 조회한다 -->
	<select id="selectSeqOrdering" resultType="int">
		SELECT distinct oseq FROM order_view
			WHERE ID=#{id} 
				AND result LIKE '%'||#{result}||'%'
				ORDER BY oseq DESC
	</select>
	
</mapper>